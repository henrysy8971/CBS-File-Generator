<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
	<title>CBS File Generator</title>
	<meta charset="UTF-8"/>
	<link rel="stylesheet" th:href="@{/webjars/bootstrap/css/bootstrap.min.css}">
	<link rel="stylesheet" th:href="@{/webjars/font-awesome/css/all.min.css}">
	<script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}" defer></script>
	<style>
		body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
		.card { border: none; box-shadow: 0 0 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
		.card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: 600; text-transform: uppercase; color: #555; }
		.btn-action { margin-bottom: 5px; }
		.status-badge { font-size: 85%; }
		.navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
	</style>
	<!-- Add CSRF token meta tags -->
	<meta name="csrf-token" th:content="${_csrf.token}"/>
	<meta name="csrf-header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div class="container mt-4">
	<!-- 1. System Health & Quick Actions -->
	<div class="row">
		<div class="col-md-4">
			<div class="card text-center">
				<div class="card-body">
					<h6 class="text-muted">API Connection</h6>
					<h3 id="healthStatus" class="text-secondary">
						<i class="fas fa-circle-notch fa-spin"></i> Checking...
					</h3>
					<button id="checkHealthBtn" type="button" class="btn btn-sm btn-outline-info mt-2">
						Check Connectivity
					</button>
				</div>
			</div>
		</div>
		<div class="col-md-8">
			<div class="card">
				<div class="card-header text-danger"><i class="fas fa-user-shield"></i> Admin Operations</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-4">
							<button class="btn btn-outline-dark w-100 btn-action admin-btn"
									type="button" data-endpoint="/reload-config">
								<i class="fas fa-sync"></i> Reload Config
							</button>
						</div>
						<div class="col-md-4">
							<button class="btn btn-outline-danger w-100 btn-action admin-btn"
									type="button" data-endpoint="/cleanup">
								<i class="fas fa-trash"></i> Force Cleanup
							</button>
						</div>
						<div class="col-md-4">
							<button class="btn btn-outline-warning w-100 btn-action admin-btn"
									type="button" data-endpoint="/scheduler/force-run">
								<i class="fas fa-bolt"></i> Force Poller
							</button>
						</div>
					</div>
					<div class="row mt-2">
						<div class="col-md-6">
							<button class="btn btn-outline-secondary w-100 btn-action admin-btn"
									type="button" data-endpoint="/scheduler/pause">
								<i class="fas fa-pause"></i> Pause Scheduler
							</button>
						</div>
						<div class="col-md-6">
							<button class="btn btn-outline-success w-100 btn-action admin-btn"
									type="button" data-endpoint="/scheduler/resume">
								<i class="fas fa-play"></i> Resume Scheduler
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<!-- 2. File Generation Request -->
	<div class="card">
		<div class="card-header text-primary">
			<i class="fas fa-file-export me-2"></i> Generate File
		</div>

		<div class="card-body">
			<form id="generateForm">
				<div class="row g-3 align-items-end">
					<div class="col-md-8">
						<label for="interfaceType"
							class="form-label small text-muted fw-bold">
								Interface Type
						</label>
						<select id="interfaceType"
								class="form-select form-select-lg">
							<option value="" disabled th:selected="${interfaceType == null}">
								Select Interface
							</option>
							<option th:each="iface : ${interfaces}"
									th:value="${iface}"
									th:text="${iface}">
							</option>
						</select>
					</div>
					<div class="col-md-4">
						<button id="generateBtn"
								type="button"
								class="btn btn-primary btn-lg w-100">
							<i class="fas fa-file-export me-2"></i>
								Generate
						</button>
					</div>
				</div>
			</form>
		</div>
	</div>
	<!-- 3. Job Monitor Table -->
	<div class="card">
		<div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
			<span><i class="fas fa-list"></i> Job History (Pending & Recent)</span>
			<div class="d-flex gap-2 align-items-center">
				<select id="statusFilter" class="form-select form-select-sm" style="width: 150px;" aria-label="Filter by Status">
					<option value="ALL">All Statuses</option>
					<option value="PENDING">Pending</option>
					<option value="PROCESSING">Processing</option>
					<option value="COMPLETED">Completed</option>
					<option value="FAILED">Failed</option>
				</select>
				<div class="input-group input-group-sm" style="max-width: 300px;">
					<span class="input-group-text bg-white"><i class="fas fa-search text-muted"></i></span>
					<input type="text" id="tableSearch" class="form-control" placeholder="Search ID or Interface..." aria-label="Search Jobs">
				</div>
				<button id="refreshTableBtn" type="button" class="btn btn-sm btn-light border">
					<i class="fas fa-sync-alt"></i> Refresh
				</button>
			</div>
		</div>
		<div class="table-responsive">
			<table class="table table-hover mb-0" id="jobsTable" style="min-width: 800px;">
				<thead class="table-light">
				<tr>
					<th scope="col">Job ID</th>
					<th scope="col">Interface</th>
					<th scope="col">Status</th>
					<th scope="col">Created</th>
					<th scope="col">Actions</th>
				</tr>
				</thead>
				<tbody>
				<tr th:each="job : ${jobs}">
					<td><code th:text="${job.jobId}"></code></td>
					<td th:text="${job.interfaceType}" class="fw-bold"></td>
					<td>
						<span th:data-status="${job.status.name()}"
							th:classappend="
								${job.status.name() == 'COMPLETED'} ? ' bg-success' :
								${job.status.name() == 'FAILED'} ? ' bg-danger' :
								${job.status.name() == 'PROCESSING'} ? ' bg-primary' :
								' bg-warning'
							"
							class="badge status-badge p-2"
							th:text="${job.status}">
						</span>
					</td>
					<td th:text="${job.createdDate}"></td>
					<td>
						<button th:if="${job.status.name() == 'COMPLETED'}"
								th:attr="data-job-id=${job.jobId}"
								type="button"
								class="btn btn-sm btn-outline-primary download-btn">
							<i class="fas fa-download"></i>
						</button>
						<button th:attr="data-job-id=${job.jobId}"
								type="button"
								class="btn btn-sm btn-outline-secondary status-btn">
							<i class="fas fa-info-circle"></i>
						</button>
					</td>
				</tr>
				<tr th:if="${#lists.isEmpty(jobs)}">
					<td colspan="5" class="text-center py-4 text-muted">
						No pending jobs found. <br/>
						<small>Check the database for historical records.</small>
					</td>
				</tr>
				<tr id="noResultsRow" style="display: none;">
					<td colspan="5" class="text-center py-4">
						<div class="text-muted">
							<i class="fas fa-search fa-2x mb-2"></i>
							<p>No jobs match your search criteria.</p>
							<button id="clearFiltersBtn" type="button" class="btn btn-sm btn-outline-secondary">Clear Filters</button>
						</div>
					</td>
				</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
<div class="toast-container position-fixed bottom-0 end-0 p-3">
	<div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
		<div class="toast-header">
			<strong class="me-auto" id="toastTitle">System Notification</strong>
			<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
		</div>
		<div class="toast-body" id="toastMessage"></div>
	</div>
</div>
<!-- JAVASCRIPT LOGIC -->
<script th:inline="javascript">
	/*<![CDATA[*/
	const CONTEXT_PATH = /*[[@{/}]]*/ '/';
	const API_BASE = CONTEXT_PATH.replace(/\/$/, "") + '/api/v1';
	/*]]>*/

	function getHeaders() {
		const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
		const csrfHeader = document.querySelector('meta[name="csrf-header"]')?.content;
		const headers = { 'Content-Type': 'application/json' };
		const headers = { 'Accept': 'application/json' };
		if(csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;
		return headers;
	}

	// --- 2. Admin Actions ---
	function callAdmin(endpoint) {
		if(!confirm("Are you sure you want to perform this Admin action?")) return;
		fetch(API_BASE + '/admin' + endpoint, {
			method: 'POST',
			headers: getHeaders(),
			credentials: 'include'
		})
		.then(async res => {
			const text = await res.text();
			if(res.ok) showToast("Success: " + text);
			else showToast(`Error (${res.status}): ${text}`, true);
		})
		.catch(err => showToast("Network Error: " + err, true));
	}

	// --- 3. Health Check ---
	function checkHealth() {
		fetch(API_BASE + '/actuator/health', {
			credentials: 'include'
		})
		.then(res => {
			if(res.ok) document.getElementById('healthStatus').innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Online</span>';
			else document.getElementById('healthStatus').innerHTML = '<span class="text-danger">Error ' + res.status + '</span>';
		})
		.catch(() => document.getElementById('healthStatus').innerHTML = '<span class="text-danger">Unreachable</span>');
	}

	// --- 4. User Actions ---
	function triggerJob(event) {
		const iface = document.getElementById('interfaceType').value;
		if(!iface) { showToast('Please select an interface type'); return; }

		const button = event.currentTarget;
		button.disabled = true;
		button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

		fetch(API_BASE + '/file-generation/generate', {
			method: 'POST',
			headers: getHeaders(),
			body: JSON.stringify({ interfaceType: iface }),
			credentials: 'include'
		})
		.then(async res => {
			let json = {}
			try {
				json = await res.json();
			} catch {}
			if(res.ok) {
				showToast("Job Started! ID: " + json.jobId);
				location.reload();
			} else {
				showToast("Failed: " + (json.message || res.statusText), true);
			}
		})
		.catch(err => showToast("Network Error", true))
		.finally(() => {
			button.disabled = false;
			button.innerHTML = '<i class="fas fa-file-export me-2"></i> Generate';
		});
	}

	function checkJobStatus(jobId) {
		const encodedJobId = encodeURIComponent(jobId);
		fetch(API_BASE + '/file-generation/getFileGenerationStatus/' + encodedJobId, {
			method: 'GET',
			headers: getHeaders(),
			credentials: 'include'
		})
		.then(async res => {
			let json = {};
			try {
				json = await res.json();
			} catch {}
			return json;
		})
		.then(json => {
			let info = `Status: ${json.status}\nRecords: ${json.recordCount}\nSkipped: ${json.skippedRecordCount}`;
			if(json.message) info += `\nMsg: ${json.message}`;
			showToast(info);
		});
	}

	function downloadFile(jobId) {
		const encodedJobId = encodeURIComponent(jobId);
		fetch(API_BASE + '/file-generation/downloadFileByJobId/' + encodedJobId, {
			method: 'GET',
			headers: getHeaders(),
			credentials: 'include'
		})
		.then(res => {
			if(!res.ok) throw new Error("Download failed: " + res.status);
			return res.blob();
		})
		.then(blob => {
			const url = window.URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = `report_${jobId}.xml`;
			document.body.appendChild(a);
			a.click();
			a.remove();
			window.URL.revokeObjectURL(url);
		})
		.catch(err => showToast("Download failed: " + err.message, true));
	}

	function showToast(message, isError = false) {
		const toastEl = document.getElementById('liveToast');
		document.getElementById('toastTitle').className = isError ? 'me-auto text-danger' : 'me-auto text-success';
		document.getElementById('toastMessage').innerText = message;
		const toast = bootstrap.Toast.getOrCreateInstance(toastEl);
		toast.show();
	}

	function filterTable() {
		const searchText = document.getElementById("tableSearch").value.toLowerCase();
		const statusFilter = document.getElementById("statusFilter").value;
		const tr = document.getElementById("jobsTable").getElementsByTagName("tr");
		let visibleCount = 0;

		for (let i = 1; i < tr.length; i++) {
			if (tr[i].id === "noResultsRow" || tr[i].cells.length < 2) continue;

			const jobId = (tr[i].cells[0]?.textContent || "").toLowerCase();
			const interfaceType = tr[i].cells[1].textContent.toLowerCase();
			const badge = tr[i].cells[2].querySelector('.status-badge');
			if (!badge) continue;
			const status = badge.dataset.status;

			const matchesSearch = jobId.includes(searchText) || interfaceType.includes(searchText);
			const matchesStatus = (statusFilter === "ALL") || (status === statusFilter);

			if (matchesSearch && matchesStatus) {
				tr[i].style.display = "";
				visibleCount++;
			} else {
				tr[i].style.display = "none";
			}
		}
		document.getElementById("noResultsRow").style.display = (visibleCount === 0) ? "" : "none";
	}

	function resetFilters() {
		document.getElementById("tableSearch").value = "";
		document.getElementById("statusFilter").value = "ALL";
		filterTable();
	}

	let pollingAttempts = 0;
	const MAX_POLLING = 40; // 10 mins

	const poller = setInterval(() => {
		const hasActiveJobs = Array.from(document.querySelectorAll('.status-badge'))
				.some(badge => badge.dataset.status === 'PROCESSING');
		if (!hasActiveJobs || pollingAttempts > MAX_POLLING) {
			clearInterval(poller);
			return;
		}

		location.reload();
		pollingAttempts++;
	}, 15000);

	document.addEventListener("DOMContentLoaded", () => {
		checkHealth();

		document.getElementById("generateBtn")?.addEventListener("click", triggerJob);
		document.getElementById("checkHealthBtn")?.addEventListener("click", checkHealth);
		document.getElementById("refreshTableBtn")?.addEventListener("click", () => location.reload());
		document.getElementById("clearFiltersBtn")?.addEventListener("click", resetFilters);

		document.getElementById("statusFilter")?.addEventListener("change", filterTable);
		document.getElementById("tableSearch")?.addEventListener("input", filterTable);
		document.querySelectorAll(".admin-btn").forEach(btn => {
			btn.addEventListener("click", function() {
				callAdmin(this.getAttribute("data-endpoint"));
			});
		});

		document.getElementById('interfaceType')
			.addEventListener('change', e => {
				document.getElementById('generateBtn').disabled = !e.target.value;
			});

		document.querySelectorAll(".download-btn").forEach(btn => {
			btn.addEventListener("click", function() {
				downloadFile(this.dataset.jobId);
			});
		});

		document.querySelectorAll(".status-btn").forEach(btn => {
			btn.addEventListener("click", function() {
				checkJobStatus(this.dataset.jobId);
			});
		});
	});
</script>
</body>
</html>